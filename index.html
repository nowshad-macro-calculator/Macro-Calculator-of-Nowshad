<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes, maximum-scale=5" />
  <title>Nowshad's Macro Calculator</title>
  <style>
    :root { --bg:#0b0f14; --card:#121923; --muted:#8aa0b6; --text:#eaf2ff; --line:#243243; --good:#4ade80; --warn:#fbbf24; --bad:#fb7185; --btn:#1f2a3a; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    h1{ font-size:20px; margin:6px 0 14px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }
    @media(min-width:920px){ .grid{ grid-template-columns: 420px 1fr; } }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .row{ display:grid; gap:10px; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    label{ font-size:12px; color:var(--muted); display:block; margin:0 0 6px; }
    input, select, button{ width:100%; border-radius:12px; border:1px solid var(--line); background:#0c131d; color:var(--text); padding:10px 12px; font-size:14px; }
    button{ background:var(--btn); cursor:pointer; border:1px solid var(--line); font-weight:600; }
    button:hover{ filter:brightness(1.08); }
    .muted{ color:var(--muted); font-size:12px; }
    .kpi{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .kpi .box{ background:#0c131d; border:1px solid var(--line); border-radius:12px; padding:10px; }
    .big{ font-size:18px; font-weight:800; margin-top:4px; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#0c131d; font-size:12px; }
    .pill.good{ border-color:rgba(74,222,128,.35); }
    .pill.warn{ border-color:rgba(251,191,36,.35); }
    .pill.bad{ border-color:rgba(251,113,133,.35); }
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--line); }
    th, td{ text-align:left; padding:10px; border-bottom:1px solid var(--line); font-size:13px; }
    th{ color:var(--muted); background:#0c131d; position:sticky; top:0; }
    tr:last-child td{ border-bottom:none; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; }
    .actions button{ width:auto; }
    .danger{ background:rgba(251,113,133,.10); border-color:rgba(251,113,133,.25); }
    .ok{ background:rgba(74,222,128,.10); border-color:rgba(74,222,128,.25); }
    .note{ font-size:12px; color:var(--muted); line-height:1.35; }
    .tag{ font-size:11px; color:var(--muted); padding:2px 8px; border:1px solid var(--line); border-radius:999px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Nowshad's Macro Calculator</h1>

    <div class="grid">
      <!-- LEFT: Profile + Targets -->
      <div class="card">
        <div class="row">
          <div class="row2">
            <div>
              <label>Weight (kg)</label>
              <input id="weightKg" type="number" step="0.1" min="20" value="107">
            </div>
            <div>
              <label>Height (cm)</label>
              <input id="heightCm" type="number" step="0.1" min="120" value="175">
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Age</label>
              <input id="age" type="number" min="10" value="35">
            </div>
            <div>
              <label>Sex</label>
              <select id="sex">
                <option value="male" selected>Male</option>
                <option value="female">Female</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Activity Level</label>
              <select id="activity">
                <option value="1.2">Sedentary (1.2)</option>
                <option value="1.375">Light (1.375)</option>
                <option value="1.55" selected>Moderate (1.55)</option>
                <option value="1.725">Very Active (1.725)</option>
                <option value="1.9">Athlete (1.9)</option>
              </select>
            </div>
            <div>
              <label>Goal</label>
              <select id="goal">
                <option value="maintain" selected>Maintain</option>
                <option value="cut">Cut</option>
                <option value="bulk">Bulk</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Protein multiplier (g/kg)</label>
              <input id="proteinMul" type="number" step="0.1" min="1" value="2.2">
              <div class="muted">Default set to 2.2 g/kg</div>
            </div>
            <div>
              <label>Macro style</label>
              <select id="macroStyle">
                <option value="high_protein" selected>Higher Protein (default)</option>
                <option value="balanced">Balanced</option>
                <option value="low_carb">Lower Carb</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Target calories (auto, editable)</label>
              <input id="targetCalories" type="number" step="1" min="800">
            </div>
            <div>
              <label>Workout calories burned (log)</label>
              <input id="workoutBurn" type="number" step="1" min="0" value="0">
            </div>
          </div>

          <div class="kpi">
            <div class="box">
              <div class="muted">BMR (kcal)</div>
              <div class="big" id="bmrOut">—</div>
            </div>
            <div class="box">
              <div class="muted">TDEE (kcal) from activity</div>
              <div class="big" id="tdeeOut">—</div>
            </div>
            <div class="box">
              <div class="muted">Assumed activity kcal (TDEE − BMR)</div>
              <div class="big" id="assumedActOut">—</div>
            </div>
            <div class="box">
              <div class="muted">Extra allowance from workout</div>
              <div class="big" id="extraAllowOut">—</div>
            </div>
          </div>

          <div class="note">
            <b>Workout rule:</b> Logging a workout will <b>not</b> reduce your remaining calories.
            It only increases your allowance if your workout burn is <b>greater</b> than the activity calories already included by your activity level.
          </div>

          <div class="row2">
            <div>
              <label>Target protein (g) (auto, editable)</label>
              <input id="targetP" type="number" step="1" min="0">
            </div>
            <div>
              <label>Target fat (g) (auto, editable)</label>
              <input id="targetF" type="number" step="1" min="0">
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Target carbs (g) (auto, editable)</label>
              <input id="targetC" type="number" step="1" min="0">
            </div>
            <div>
              <label>Selected date</label>
              <input id="logDate" type="date">
            </div>
          </div>

          <div class="actions">
            <button id="recalcBtn">Recalculate targets</button>
            <button id="saveBtn">Save</button>
            <button id="resetBtn" class="danger">Reset day log</button>
          </div>
          <div class="muted">Everything is stored locally in your browser (localStorage).</div>
        </div>
      </div>

      <!-- RIGHT: Food log -->
      <div class="card">
        <div class="row">
          <div class="row2">
            <div>
              <label>Search food</label>
              <input id="foodSearch" placeholder="Type: chicken, rice, egg, bread..." />
            </div>
            <div>
              <label>Pick food</label>
              <select id="foodPick"></select>
            </div>
          </div>

          <div class="row3">
            <div>
              <label>Amount</label>
              <input id="amount" type="number" step="1" min="0" value="100">
            </div>
            <div>
              <label>Unit</label>
              <select id="unitPick"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="addFoodBtn">Add to log</button>
            </div>
          </div>

          <div class="kpi">
            <div class="box">
              <div class="muted">Consumed calories</div>
              <div class="big" id="consKcal">0</div>
            </div>
            <div class="box">
              <div class="muted">Remaining calories</div>
              <div class="big" id="remKcal">0</div>
            </div>
            <div class="box">
              <div class="muted">Protein / Target (g)</div>
              <div class="big" id="consP">0 / 0</div>
            </div>
            <div class="box">
              <div class="muted">Carbs / Target (g)</div>
              <div class="big" id="consC">0 / 0</div>
            </div>
            <div class="box">
              <div class="muted">Fat / Target (g)</div>
              <div class="big" id="consF">0 / 0</div>
            </div>
            <div class="box">
              <div class="muted">Status</div>
              <div class="big" id="statusPill">—</div>
            </div>
          </div>

          <div class="note">
            <b>Protein mismatch fix:</b> totals are calculated using full precision and rounded only at the end.
            So if you add exactly 100g protein across items, it won’t display as 98g due to rounding.
          </div>

          <div style="max-height:360px; overflow:auto; border-radius:12px;">
            <table>
              <thead>
                <tr>
                  <th>Food</th>
                  <th>Amount</th>
                  <th>kcal</th>
                  <th>P</th>
                  <th>C</th>
                  <th>F</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="logTable"></tbody>
            </table>
          </div>

          <div class="actions">
            <button id="exportBtn">Export day log (JSON)</button>
            <button id="importBtn">Import day log (JSON)</button>
            <input id="importFile" type="file" accept="application/json" style="display:none;">
          </div>

          <div class="muted">Tip: If you want, I can merge this logic into your existing file too — but this is a clean “no-error” full replacement.</div>
        </div>
      </div>
    </div>
  </div>

<script>
/** -------------------------
 *  Food DB (you can expand)
 *  Per unit macros: P,C,F,K
 *  ------------------------- */
const FOOD = {
  "Chicken Breast (skinless)": { units:["g"], per:{ g:{P:0.31, C:0, F:0.036, K:1.65} } },
  "Egg (whole)": { units:["piece"], per:{ piece:{P:6.3, C:0.4, F:5.0, K:72} } },
  "Rice (cooked, plain)": { units:["g"], per:{ g:{P:0.027, C:0.28, F:0.003, K:1.30} } },
  "Bread (white)": { units:["slice","g"], per:{ slice:{P:2.7, C:13.0, F:1.0, K:70}, g:{P:0.09, C:0.43, F:0.033, K:2.65} } },
  "Bread (brown/whole wheat)": { units:["slice","g"], per:{ slice:{P:3.6, C:12.0, F:1.2, K:75}, g:{P:0.11, C:0.40, F:0.04, K:2.55} } },
  "Butter bun": { units:["piece"], per:{ piece:{P:6, C:52, F:10, K:330} } },
  "Banana": { units:["piece","g"], per:{ piece:{P:1.3, C:27, F:0.3, K:105}, g:{P:0.011, C:0.23, F:0.003, K:0.89} } },
  "Milk (whole)": { units:["ml"], per:{ ml:{P:0.033, C:0.05, F:0.033, K:0.61} } },
  "Whey protein (1 scoop)": { units:["scoop"], per:{ scoop:{P:24, C:3, F:2, K:120} } },
  "Olive oil": { units:["tbsp","g"], per:{ tbsp:{P:0, C:0, F:13.5, K:119}, g:{P:0, C:0, F:1.0, K:8.84} } },
};

/** -------------------------
 *  Helpers: precise summing
 *  ------------------------- */
const round1 = (n)=> Math.round((n + Number.EPSILON) * 10) / 10;
const round0 = (n)=> Math.round(n + Number.EPSILON);
const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));

/** -------------------------
 *  Storage keys
 *  ------------------------- */
const LS_PROFILE = "nowshad_macro_profile_v2";
const LS_LOGS = "nowshad_macro_logs_v2"; // date -> entries array

/** -------------------------
 *  State
 *  ------------------------- */
let profile = {};
let logsByDate = {}; // { "YYYY-MM-DD": [ {name, amount, unit, m:{P,C,F,K}} ] }

/** -------------------------
 *  DOM
 *  ------------------------- */
const el = (id)=>document.getElementById(id);
const weightKg = el("weightKg");
const heightCm = el("heightCm");
const age = el("age");
const sex = el("sex");
const activity = el("activity");
const goal = el("goal");
const proteinMul = el("proteinMul");
const macroStyle = el("macroStyle");

const targetCalories = el("targetCalories");
const targetP = el("targetP");
const targetC = el("targetC");
const targetF = el("targetF");

const workoutBurn = el("workoutBurn");
const logDate = el("logDate");

const bmrOut = el("bmrOut");
const tdeeOut = el("tdeeOut");
const assumedActOut = el("assumedActOut");
const extraAllowOut = el("extraAllowOut");

const foodSearch = el("foodSearch");
const foodPick = el("foodPick");
const unitPick = el("unitPick");
const amount = el("amount");
const addFoodBtn = el("addFoodBtn");

const consKcal = el("consKcal");
const remKcal = el("remKcal");
const consP = el("consP");
const consC = el("consC");
const consF = el("consF");
const statusPill = el("statusPill");
const logTable = el("logTable");

/** -------------------------
 *  BMR / TDEE / Targets
 *  Mifflin-St Jeor
 *  ------------------------- */
function calcBMR({w,h,a,sex}) {
  // w kg, h cm, a years
  const base = (10*w) + (6.25*h) - (5*a);
  return sex === "male" ? (base + 5) : (base - 161);
}
function goalAdjust(goal) {
  if (goal === "cut") return -400;
  if (goal === "bulk") return +300;
  return 0;
}

/** Macro split logic */
function computeTargetsFromCalories({calories, wKg, proteinMul, style}) {
  // Protein first (g)
  let p = wKg * proteinMul; // grams
  // minimum sanity
  p = clamp(p, 80, 320);

  // Fat baseline
  let f;
  if (style === "high_protein") f = wKg * 0.7;      // moderate fat
  else if (style === "low_carb") f = wKg * 1.0;     // higher fat
  else f = wKg * 0.8;                               // balanced

  f = clamp(f, 40, 140);

  // Remaining calories to carbs
  const calFromP = p * 4;
  const calFromF = f * 9;
  let remaining = calories - (calFromP + calFromF);
  let c = remaining / 4;

  // If carbs too low, soften fats a bit (avoid negative carbs)
  if (c < 50) {
    const needed = (50 - c) * 4;
    // reduce fat calories first
    const reduceFatCal = Math.min(needed, f * 9 - 40 * 9);
    f = f - (reduceFatCal / 9);
    remaining = calories - (p*4 + f*9);
    c = remaining / 4;
  }

  c = clamp(c, 50, 500);

  return {
    P: round0(p),
    F: round0(f),
    C: round0(c),
  };
}

/** -------------------------
 *  Workout rule (YOUR REQUEST)
 *  - TDEE already includes assumed activity calories
 *  - only if workoutBurn > assumedActivityCals:
 *      extraAllowance = workoutBurn - assumedActivityCals
 *  - allowedCalories = targetCalories + extraAllowance
 *  ------------------------- */
function getWorkoutAllowance(bmr, tdee, workout) {
  const assumedActivity = Math.max(0, tdee - bmr);
  const extraAllowance = Math.max(0, workout - assumedActivity);
  return { assumedActivity, extraAllowance };
}

/** -------------------------
 *  Food selection + macros
 *  ------------------------- */
function listFoods(filter="") {
  const q = filter.trim().toLowerCase();
  const names = Object.keys(FOOD).sort();
  const filtered = q ? names.filter(n => n.toLowerCase().includes(q)) : names;
  foodPick.innerHTML = filtered.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");
  if (filtered.length) setUnitsForFood(filtered[0]);
}
function setUnitsForFood(name) {
  const f = FOOD[name];
  unitPick.innerHTML = f.units.map(u => `<option value="${u}">${u}</option>`).join("");
}
function macrosFor(name, amt, unit) {
  const f = FOOD[name];
  const base = f.per[unit];
  // base values: either per gram (ratios) or per unit
  return {
    P: base.P * amt,
    C: base.C * amt,
    F: base.F * amt,
    K: base.K * amt,
  };
}

/** -------------------------
 *  Logs per date
 *  ------------------------- */
function currentDateKey() {
  return logDate.value;
}
function getEntries(dateKey) {
  return logsByDate[dateKey] || [];
}
function setEntries(dateKey, entries) {
  logsByDate[dateKey] = entries;
  saveAll();
}

/** -------------------------
 *  Totals (precise sum, round once)
 *  ------------------------- */
function sumTotals(entries) {
  let P=0, C=0, F=0, K=0;
  for (const e of entries) {
    P += e.m.P;
    C += e.m.C;
    F += e.m.F;
    K += e.m.K;
  }
  return {
    P, C, F, K,
    P_r: round0(P),
    C_r: round0(C),
    F_r: round0(F),
    K_r: round0(K),
  };
}

/** -------------------------
 *  Render
 *  ------------------------- */
function render() {
  // profile values
  const w = Number(weightKg.value || 0);
  const h = Number(heightCm.value || 0);
  const a = Number(age.value || 0);
  const sx = sex.value;
  const act = Number(activity.value || 1.2);
  const g = goal.value;

  const bmr = calcBMR({w,h,a,sex:sx});
  const tdee = bmr * act;

  // auto calories if blank or if user hits recalc
  if (!targetCalories.value) {
    targetCalories.value = round0(tdee + goalAdjust(g));
  }

  // Workout allowance
  const workout = Number(workoutBurn.value || 0);
  const { assumedActivity, extraAllowance } = getWorkoutAllowance(bmr, tdee, workout);

  bmrOut.textContent = round0(bmr);
  tdeeOut.textContent = round0(tdee);
  assumedActOut.textContent = round0(assumedActivity);
  extraAllowOut.textContent = round0(extraAllowance);

  // Targets autos (only if empty)
  const calTarget = Number(targetCalories.value || 0);

  if (!targetP.value || !targetC.value || !targetF.value) {
    const mt = computeTargetsFromCalories({
      calories: calTarget,
      wKg: w,
      proteinMul: Number(proteinMul.value || 2.2),
      style: macroStyle.value
    });
    targetP.value = mt.P;
    targetC.value = mt.C;
    targetF.value = mt.F;
  }

  // Render food list and table
  const dateKey = currentDateKey();
  const entries = getEntries(dateKey);
  const totals = sumTotals(entries);

  const allowedCalories = calTarget + extraAllowance; // key rule
  const remainingCalories = allowedCalories - totals.K;

  consKcal.textContent = totals.K_r;
  remKcal.textContent = round0(remainingCalories);

  consP.textContent = `${totals.P_r} / ${round0(Number(targetP.value||0))}`;
  consC.textContent = `${totals.C_r} / ${round0(Number(targetC.value||0))}`;
  consF.textContent = `${totals.F_r} / ${round0(Number(targetF.value||0))}`;

  // Status pill
  const status = remainingCalories >= 0 ? "On track" : "Over";
  const pillClass = remainingCalories >= 0 ? "pill good" : "pill bad";
  statusPill.innerHTML = `<span class="${pillClass}">${status} <span class="tag">${round0(remainingCalories)} kcal</span></span>`;

  // Table
  logTable.innerHTML = entries.map((e, idx) => {
    return `
      <tr>
        <td>${escapeHtml(e.name)}</td>
        <td>${round1(e.amount)} ${escapeHtml(e.unit)}</td>
        <td>${round0(e.m.K)}</td>
        <td>${round0(e.m.P)}</td>
        <td>${round0(e.m.C)}</td>
        <td>${round0(e.m.F)}</td>
        <td><button onclick="removeEntry(${idx})">Remove</button></td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="7" class="muted">No foods logged for this date.</td></tr>`;
}

/** -------------------------
 *  Actions
 *  ------------------------- */
window.removeEntry = function(idx) {
  const dateKey = currentDateKey();
  const entries = getEntries(dateKey);
  entries.splice(idx,1);
  setEntries(dateKey, entries);
  render();
}

function addFood() {
  const name = foodPick.value;
  const unit = unitPick.value;
  const amt = Number(amount.value || 0);
  if (!name || !unit || !amt) return;

  const m = macrosFor(name, amt, unit);
  const entry = { name, unit, amount: amt, m, ts: Date.now() };

  const dateKey = currentDateKey();
  const entries = getEntries(dateKey);
  entries.push(entry);
  setEntries(dateKey, entries);
  render();
}

function recalcTargets(force=true) {
  const w = Number(weightKg.value || 0);
  const h = Number(heightCm.value || 0);
  const a = Number(age.value || 0);
  const sx = sex.value;
  const act = Number(activity.value || 1.2);
  const g = goal.value;

  const bmr = calcBMR({w,h,a,sex:sx});
  const tdee = bmr * act;
  targetCalories.value = round0(tdee + goalAdjust(g));

  const mt = computeTargetsFromCalories({
    calories: Number(targetCalories.value||0),
    wKg: w,
    proteinMul: Number(proteinMul.value || 2.2),
    style: macroStyle.value
  });

  targetP.value = mt.P;
  targetC.value = mt.C;
  targetF.value = mt.F;

  render();
}

function resetDay() {
  const dateKey = currentDateKey();
  setEntries(dateKey, []);
  render();
}

function exportDay() {
  const dateKey = currentDateKey();
  const payload = {
    date: dateKey,
    entries: getEntries(dateKey),
    profile: readProfileFromUI()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `macro-log-${dateKey}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

function importDay(file) {
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (data.profile) applyProfileToUI(data.profile);
      if (data.date && Array.isArray(data.entries)) {
        logsByDate[data.date] = data.entries;
        logDate.value = data.date;
      }
      saveAll();
      render();
    } catch(e) {
      alert("Invalid JSON file.");
    }
  };
  reader.readAsText(file);
}

/** -------------------------
 *  Persistence
 *  ------------------------- */
function readProfileFromUI() {
  return {
    weightKg: Number(weightKg.value||0),
    heightCm: Number(heightCm.value||0),
    age: Number(age.value||0),
    sex: sex.value,
    activity: Number(activity.value||1.2),
    goal: goal.value,
    proteinMul: Number(proteinMul.value||2.2),
    macroStyle: macroStyle.value,
    targetCalories: Number(targetCalories.value||0),
    targetP: Number(targetP.value||0),
    targetC: Number(targetC.value||0),
    targetF: Number(targetF.value||0),
    workoutBurn: Number(workoutBurn.value||0),
  };
}
function applyProfileToUI(p) {
  if (!p) return;
  weightKg.value = p.weightKg ?? weightKg.value;
  heightCm.value = p.heightCm ?? heightCm.value;
  age.value = p.age ?? age.value;
  sex.value = p.sex ?? sex.value;
  activity.value = String(p.activity ?? activity.value);
  goal.value = p.goal ?? goal.value;
  proteinMul.value = p.proteinMul ?? proteinMul.value;
  macroStyle.value = p.macroStyle ?? macroStyle.value;

  targetCalories.value = p.targetCalories ?? targetCalories.value;
  targetP.value = p.targetP ?? targetP.value;
  targetC.value = p.targetC ?? targetC.value;
  targetF.value = p.targetF ?? targetF.value;

  workoutBurn.value = p.workoutBurn ?? workoutBurn.value;
}
function saveAll() {
  localStorage.setItem(LS_PROFILE, JSON.stringify(readProfileFromUI()));
  localStorage.setItem(LS_LOGS, JSON.stringify(logsByDate));
}
function loadAll() {
  try {
    const p = JSON.parse(localStorage.getItem(LS_PROFILE) || "{}");
    applyProfileToUI(p);
  } catch {}
  try {
    logsByDate = JSON.parse(localStorage.getItem(LS_LOGS) || "{}") || {};
  } catch { logsByDate = {}; }
}

/** -------------------------
 *  Utils
 *  ------------------------- */
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/** -------------------------
 *  Init
 *  ------------------------- */
function init() {
  // set today
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  logDate.value = `${yyyy}-${mm}-${dd}`;

  loadAll();
  listFoods("");

  // Bind food pick change
  foodPick.addEventListener("change", ()=> setUnitsForFood(foodPick.value));
  foodSearch.addEventListener("input", ()=> {
    listFoods(foodSearch.value);
    if (foodPick.value) setUnitsForFood(foodPick.value);
  });

  // Bind profile changes
  [
    weightKg, heightCm, age, sex, activity, goal,
    proteinMul, macroStyle, targetCalories, targetP, targetC, targetF,
    workoutBurn, logDate
  ].forEach(x => x.addEventListener("input", ()=> { saveAll(); render(); }));

  addFoodBtn.addEventListener("click", ()=> addFood());
  el("recalcBtn").addEventListener("click", ()=> recalcTargets(true));
  el("saveBtn").addEventListener("click", ()=> { saveAll(); render(); });

  el("resetBtn").addEventListener("click", ()=> {
    if (confirm("Reset all foods for this date?")) resetDay();
  });

  el("exportBtn").addEventListener("click", ()=> exportDay());
  el("importBtn").addEventListener("click", ()=> el("importFile").click());
  el("importFile").addEventListener("change", (e)=> {
    const f = e.target.files?.[0];
    if (f) importDay(f);
    e.target.value = "";
  });

  render();
}
init();
</script>
</body>
</html>
